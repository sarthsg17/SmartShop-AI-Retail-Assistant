<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Wishlist - SmartShop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-out {
      opacity: 0;
      transform: scale(0.95);
      transition: all 0.3s ease-in-out;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-teal-50 to-white min-h-screen flex flex-col text-gray-900">

  <!-- Navbar -->
  <nav class="bg-teal-600 text-white px-6 py-4 flex justify-between items-center shadow-md">
    <div class="text-2xl font-bold">SmartShop</div>
    <div class="space-x-4 text-lg">
      <a href="/dashboard" class="hover:underline">Home</a>
      <a href="/products" class="hover:underline">Products</a>
      <a href="/cart" class="hover:underline">Cart</a>
      <a href="/auth/logout" class="text-red-200 hover:underline">Logout</a>
    </div>
  </nav>

  <!-- Wishlist Section -->
  <main class="flex-grow px-6 py-10">
    <div class="max-w-7xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-teal-700">
          My Wishlist <span id="wishlist-count" class="text-base text-gray-500 font-medium">({{ wishlist|length }} items)</span>
        </h2>
        <div>
          <label class="text-sm mr-2">Sort:</label>
          <select onchange="sortWishlist(this.value)" class="border rounded px-2 py-1 text-sm">
            <option value="asc">Price: Low to High</option>
            <option value="desc">Price: High to Low</option>
          </select>
        </div>
      </div>

      {% if wishlist %}
        <div id="wishlist-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
      {% else %}
        <div class="text-center mt-20">
          <p class="text-gray-600 text-lg">
            Your wishlist is empty.<br />
            Start exploring <a href="/products" class="text-teal-600 font-semibold hover:underline">products</a> and save your favorites!
          </p>
        </div>
      {% endif %}
    </div>
  </main>

  <!-- AI Assistant Toggle Button -->
  <div class="fixed bottom-6 right-6 z-40">
    <button onclick="toggleAI()" class="bg-teal-600 text-white p-3 rounded-full shadow-lg hover:bg-teal-700">
      ðŸ¤–
    </button>
  </div>

  <!-- AI Assistant Box -->
  <div class="aiBox fixed bottom-20 right-6 bg-white border shadow-lg rounded-lg p-4 w-80 hidden z-50">
    <h3 class="text-lg font-semibold mb-2">ðŸ§  Ask AI Assistant</h3>
    <form class="aiForm" autocomplete="off">
      <input class="aiInput" type="text" name="message" placeholder="Ask about your orders, account..." required class="w-full px-3 py-2 border border-gray-300 rounded mb-2" />
      <button type="submit" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700 w-full">Ask</button>
    </form>
    <div class="aiReply bg-gray-100 border rounded p-2 mt-2 text-sm max-h-40 overflow-y-auto hidden"></div>
  </div>
  <script>
    let originalWishlist = {{ wishlist | tojson }};
    const container = document.getElementById("wishlist-container");
    const countText = document.getElementById("wishlist-count");

    async function handleAddToCart(productId, wishlistId, cardId) {
      try {
        const title = document.getElementById(`title-${wishlistId}`).innerText;
        const price = document.getElementById(`price-${wishlistId}`).dataset.price;
        const image = document.getElementById(`image-${wishlistId}`).src;

        const res = await fetch(`/add-to-cart/${productId}?title=${encodeURIComponent(title)}&price=${price}&image=${encodeURIComponent(image)}`, { method: "POST" });
        if (!res.ok) throw new Error("Failed to add to cart");

        await handleRemove(wishlistId, cardId, false); // false means no fetch on remove
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    async function handleRemove(wishlistId, cardId, refresh = true) {
      try {
        const res = await fetch(`/wishlist/remove/${wishlistId}`, { method: "POST" });
        if (!res.ok) throw new Error("Failed to remove");

        const card = document.getElementById(cardId);
        card.classList.add("fade-out");
        setTimeout(() => {
          card.remove();
          if (refresh) fetchWishlist(); // Refresh local data
        }, 300);
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    function sortWishlist(order) {
      const sorted = [...originalWishlist].sort((a, b) => {
        return order === "asc" ? a.price - b.price : b.price - a.price;
      });
      renderWishlist(sorted);
    }

    async function fetchWishlist() {
      const res = await fetch("/api/user-wishlist");
      const data = await res.json();
      originalWishlist = data;
      renderWishlist(data);
    }

    function renderWishlist(data) {
      container.innerHTML = "";
      countText.innerText = `(${data.length} items)`;

      data.forEach(item => {
        const inrPrice = Math.floor(parseFloat(item.price) * 85);
        container.innerHTML += `
          <div id="wishlist-card-${item.id}" class="bg-white rounded-xl shadow-md p-4 transition transform duration-300">
            <img id="image-${item.id}" src="${item.image_url}" alt="${item.title}" class="w-full h-48 object-cover rounded mb-3">
            <h3 id="title-${item.id}" class="text-lg font-semibold text-gray-800 mb-1">${item.title}</h3>
            <p id="price-${item.id}" data-price="${item.price}" class="text-gray-600 mb-4">â‚¹${inrPrice}</p>
            <div class="flex justify-between items-center gap-2">
              <button onclick="handleAddToCart(${item.product_id}, ${item.id}, 'wishlist-card-${item.id}')" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">Add to Cart</button>
              <button onclick="handleRemove(${item.id}, 'wishlist-card-${item.id}')" class="text-red-600 text-sm hover:underline">Remove</button>
            </div>
          </div>`;
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderWishlist(originalWishlist);
    });

    function toggleAI() {
      document.querySelector('.aiBox').classList.toggle('hidden');
    }
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.aiForm').forEach(function(form) {
        form.onsubmit = async function(e) {
          e.preventDefault();
          const input = form.querySelector('.aiInput');
          const replyBox = form.parentElement.querySelector('.aiReply');
          replyBox.classList.remove('hidden');
          replyBox.innerHTML = '<span class="text-gray-400">Thinking...</span>';
          const res = await fetch('/api/ask?from_page=wishlist', {
            method: 'POST',
            body: new URLSearchParams({ message: input.value })
          });
          const data = await res.json();
          replyBox.innerHTML = '<strong>AI says:</strong><br>' + (data.reply || '<span class="text-red-500">Sorry, no reply.</span>');
          input.value = '';
          return false;
        };
      });
    });
  </script>
</body>
</html>
