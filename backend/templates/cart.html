<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Cart - SmartShop</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-teal-50 to-white min-h-screen text-gray-900 flex flex-col">

  <!-- Navbar -->
  <nav class="bg-teal-600 text-white px-6 py-4 flex justify-between items-center shadow-md">
    <div class="text-2xl font-bold">SmartShop</div>
    <div class="space-x-4 text-lg">
      <a href="/dashboard" class="hover:underline">Home</a>
      <a href="/wishlist" class="hover:underline">Wishlist</a>
      <a href="/products" class="hover:underline">Products</a>
      <a href="/auth/logout" class="text-red-200 hover:underline">Logout</a>
    </div>
  </nav>

  <!-- Cart Section -->
  <main class="flex-grow max-w-7xl mx-auto px-6 py-10">
    <h1 class="text-4xl font-bold text-teal-700 mb-6">ðŸ›’ Your Cart</h1>

    <!-- Container for JS-rendered products -->
    <div id="cart-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>

    <!-- Total + Checkout -->
    <div id="cart-summary" class="mt-10 text-right hidden">
      <p id="total-amount" class="text-xl font-semibold text-gray-700 mb-2"></p>
      <form action="/cod-checkout" method="post">
        <button class="bg-teal-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-teal-700 transition shadow">
          Checkout
        </button>
      </form>
    </div>
  </main>

  <!-- AI Assistant Toggle Button -->
  <div class="fixed bottom-6 right-6 z-40">
    <button onclick="toggleAI()" class="bg-teal-600 text-white p-3 rounded-full shadow-lg hover:bg-teal-700">
      ðŸ¤–
    </button>
  </div>

  <!-- AI Assistant Box -->
  <div class="aiBox fixed bottom-20 right-6 bg-white border shadow-lg rounded-lg p-4 w-80 hidden z-50">
    <h3 class="text-lg font-semibold mb-2">ðŸ§  Ask AI Assistant</h3>
    <form class="aiForm" autocomplete="off">
      <input class="aiInput" type="text" name="message" placeholder="Ask about your orders, account..." required class="w-full px-3 py-2 border border-gray-300 rounded mb-2" />
      <button type="submit" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700 w-full">Ask</button>
    </form>
    <div class="aiReply bg-gray-100 border rounded p-2 mt-2 text-sm max-h-40 overflow-y-auto hidden"></div>
  </div>
  <script>
    function toggleAI() {
      document.querySelector('.aiBox').classList.toggle('hidden');
    }
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.aiForm').forEach(function(form) {
        form.onsubmit = async function(e) {
          e.preventDefault();
          const input = form.querySelector('.aiInput');
          const replyBox = form.parentElement.querySelector('.aiReply');
          replyBox.classList.remove('hidden');
          replyBox.innerHTML = '<span class="text-gray-400">Thinking...</span>';
          const res = await fetch('/api/ask?from_page=cart', {
            method: 'POST',
            body: new URLSearchParams({ message: input.value })
          });
          const data = await res.json();
          replyBox.innerHTML = '<strong>AI says:</strong><br>' + (data.reply || '<span class="text-red-500">Sorry, no reply.</span>');
          input.value = '';
          return false;
        };
      });
    });
  </script>

  <!-- JS: Render Cart Only -->
  <script>
    const cartData = {{ cart | tojson }};
    
    function renderCartProducts(products) {
      const container = document.getElementById("cart-container");
      const summary = document.getElementById("cart-summary");
      const totalText = document.getElementById("total-amount");

      container.innerHTML = "";
      let total = 0;

      if (products.length === 0) {
        container.innerHTML = `
          <p class="text-gray-600 text-lg">Your cart is empty.
          <a href="/products" class="text-teal-600 font-medium hover:underline">Shop now</a></p>`;
        summary.classList.add("hidden");
        return;
      }

      products.forEach(item => {
        const inrPrice = Math.floor(parseFloat(item.price) * 85);
        total += inrPrice;

        const card = document.createElement("div");
        card.className = "bg-white rounded-xl shadow-md p-4";
        card.innerHTML = `
          <img src="${item.image}" alt="${item.title}" class="w-full h-48 object-contain rounded mb-3" />
          <h2 class="text-lg font-semibold mb-1">${item.title}</h2>
          <div class="flex items-center justify-between mt-2">
            <p class="text-teal-600 font-bold text-base">â‚¹${inrPrice}</p>
            <form action="/cart/remove/${item.id}" method="post">
              <button class="text-red-600 text-sm hover:underline">ðŸ—‘ Remove</button>
            </form>
          </div>
        `;
        container.appendChild(card);
      });

      summary.classList.remove("hidden");
      totalText.textContent = `Total: â‚¹${total}`;
    }

    renderCartProducts(cartData);
  </script>
</body>
</html>
